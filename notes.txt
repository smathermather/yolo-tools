## log before installing onnxsim

csnipes@COREY-LAPTOP ~/work/yolov7
$ python export.py --weights runs/train/poland1b_det2/weights/best.pt --grid --simplify --img-size 1200 1200
Import onnx_graphsurgeon failure: No module named 'onnx_graphsurgeon'
Namespace(weights='runs/train/poland1b_det2/weights/best.pt', img_size=[1200, 1200], batch_size=1, dynamic=Fal
se, dynamic_batch=False, grid=True, end2end=False, max_wh=None, topk_all=100, iou_thres=0.45, conf_thres=0.25,
 device='cpu', simplify=True, include_nms=False, fp16=False, int8=False)
YOLOR  v0.1-128-ga207844 torch 2.1.2+cpu CPU

Fusing layers...
IDetect.fuse
C:\Users\csnipes\AppData\Local\Programs\Python\Python311\Lib\site-packages\torch\functional.py:504: UserWarnin
g: torch.meshgrid: in an upcoming release, it will be required to pass the indexing argument. (Triggered inter
nally at ..\aten\src\ATen\native\TensorShape.cpp:3527.)
  return _VF.meshgrid(tensors, **kwargs)  # type: ignore[attr-defined]
Model Summary: 208 layers, 6007596 parameters, 0 gradients, 13.0 GFLOPS
WARNING: --img-size 1200 must be multiple of max stride 32, updating to 1216
WARNING: --img-size 1200 must be multiple of max stride 32, updating to 1216

Starting TorchScript export with torch 2.1.2+cpu...
C:\Users\csnipes\work\yolov7\models\yolo.py:150: TracerWarning: Converting a tensor to a Python boolean might
cause the trace to be incorrect. We can't record the data flow of Python values, so this value will be treated
 as a constant in the future. This means that the trace might not generalize to other inputs!
  if self.grid[i].shape[2:4] != x[i].shape[2:4]:
TorchScript export success, saved as runs/train/poland1b_det2/weights/best.torchscript.pt
CoreML export failure: No module named 'coremltools'

Starting TorchScript-Lite export with torch 2.1.2+cpu...
TorchScript-Lite export success, saved as runs/train/poland1b_det2/weights/best.torchscript.ptl

Starting ONNX export with onnx 1.16.0...
C:\Users\csnipes\work\yolov7\models\yolo.py:582: TracerWarning: Converting a tensor to a Python boolean might
cause the trace to be incorrect. We can't record the data flow of Python values, so this value will be treated
 as a constant in the future. This means that the trace might not generalize to other inputs!
  if augment:
C:\Users\csnipes\work\yolov7\models\yolo.py:614: TracerWarning: Converting a tensor to a Python boolean might
cause the trace to be incorrect. We can't record the data flow of Python values, so this value will be treated
 as a constant in the future. This means that the trace might not generalize to other inputs!
  if profile:
C:\Users\csnipes\work\yolov7\models\yolo.py:629: TracerWarning: Converting a tensor to a Python boolean might
cause the trace to be incorrect. We can't record the data flow of Python values, so this value will be treated
 as a constant in the future. This means that the trace might not generalize to other inputs!
  if profile:
Simplifier failure: No module named 'onnxsim'
ONNX export success, saved as runs/train/poland1b_det2/weights/best.onnx

Export complete (7.87s). Visualize with https://github.com/lutzroeder/netron.

# log after installing onnxsim

$ python export.py --weights runs/train/poland1b_det2/weights/best.pt --grid --simplify --img-size 1200 1200
Import onnx_graphsurgeon failure: No module named 'onnx_graphsurgeon'
Namespace(weights='runs/train/poland1b_det2/weights/best.pt', img_size=[1200, 1200], batch_size=1, dynamic=Fal
se, dynamic_batch=False, grid=True, end2end=False, max_wh=None, topk_all=100, iou_thres=0.45, conf_thres=0.25,
 device='cpu', simplify=True, include_nms=False, fp16=False, int8=False)
YOLOR  v0.1-128-ga207844 torch 2.1.2+cpu CPU

Fusing layers...
IDetect.fuse
C:\Users\csnipes\AppData\Local\Programs\Python\Python311\Lib\site-packages\torch\functional.py:504: UserWarnin
g: torch.meshgrid: in an upcoming release, it will be required to pass the indexing argument. (Triggered inter
nally at ..\aten\src\ATen\native\TensorShape.cpp:3527.)
  return _VF.meshgrid(tensors, **kwargs)  # type: ignore[attr-defined]
Model Summary: 208 layers, 6007596 parameters, 0 gradients, 13.0 GFLOPS
WARNING: --img-size 1200 must be multiple of max stride 32, updating to 1216
WARNING: --img-size 1200 must be multiple of max stride 32, updating to 1216

Starting TorchScript export with torch 2.1.2+cpu...
C:\Users\csnipes\work\yolov7\models\yolo.py:150: TracerWarning: Converting a tensor to a Python boolean might
cause the trace to be incorrect. We can't record the data flow of Python values, so this value will be treated
 as a constant in the future. This means that the trace might not generalize to other inputs!
  if self.grid[i].shape[2:4] != x[i].shape[2:4]:
TorchScript export success, saved as runs/train/poland1b_det2/weights/best.torchscript.pt
CoreML export failure: No module named 'coremltools'

Starting TorchScript-Lite export with torch 2.1.2+cpu...
TorchScript-Lite export success, saved as runs/train/poland1b_det2/weights/best.torchscript.ptl

Starting ONNX export with onnx 1.16.0...
C:\Users\csnipes\work\yolov7\models\yolo.py:582: TracerWarning: Converting a tensor to a Python boolean might
cause the trace to be incorrect. We can't record the data flow of Python values, so this value will be treated
 as a constant in the future. This means that the trace might not generalize to other inputs!
  if augment:
C:\Users\csnipes\work\yolov7\models\yolo.py:614: TracerWarning: Converting a tensor to a Python boolean might
cause the trace to be incorrect. We can't record the data flow of Python values, so this value will be treated
 as a constant in the future. This means that the trace might not generalize to other inputs!
  if profile:
C:\Users\csnipes\work\yolov7\models\yolo.py:629: TracerWarning: Converting a tensor to a Python boolean might
cause the trace to be incorrect. We can't record the data flow of Python values, so this value will be treated
 as a constant in the future. This means that the trace might not generalize to other inputs!
  if profile:
Installing onnxruntime by `C:\Users\csnipes\AppData\Local\Programs\Python\Python311\python.exe -m pip install
onnxruntime`, please wait for a moment..
Collecting onnxruntime
  Using cached onnxruntime-1.17.3-cp311-cp311-win_amd64.whl.metadata (4.6 kB)
Requirement already satisfied: coloredlogs in c:\users\csnipes\appdata\local\programs\python\python311\lib\sit
e-packages (from onnxruntime) (15.0.1)
Requirement already satisfied: flatbuffers in c:\users\csnipes\appdata\local\programs\python\python311\lib\sit
e-packages (from onnxruntime) (24.3.25)
Requirement already satisfied: numpy>=1.24.2 in c:\users\csnipes\appdata\local\programs\python\python311\lib\s
ite-packages (from onnxruntime) (1.26.4)
Requirement already satisfied: packaging in c:\users\csnipes\appdata\local\programs\python\python311\lib\site-
packages (from onnxruntime) (23.2)
Requirement already satisfied: protobuf in c:\users\csnipes\appdata\local\programs\python\python311\lib\site-p
ackages (from onnxruntime) (3.20.3)
Requirement already satisfied: sympy in c:\users\csnipes\appdata\local\programs\python\python311\lib\site-pack
ages (from onnxruntime) (1.12)
Requirement already satisfied: humanfriendly>=9.1 in c:\users\csnipes\appdata\local\programs\python\python311\
lib\site-packages (from coloredlogs->onnxruntime) (10.0)
Requirement already satisfied: mpmath>=0.19 in c:\users\csnipes\appdata\local\programs\python\python311\lib\si
te-packages (from sympy->onnxruntime) (1.3.0)
Requirement already satisfied: pyreadline3 in c:\users\csnipes\appdata\local\programs\python\python311\lib\sit
e-packages (from humanfriendly>=9.1->coloredlogs->onnxruntime) (3.4.1)
Using cached onnxruntime-1.17.3-cp311-cp311-win_amd64.whl (5.6 MB)
Installing collected packages: onnxruntime
Successfully installed onnxruntime-1.17.3

Starting to simplify ONNX...
ONNX export success, saved as runs/train/poland1b_det2/weights/best.onnx

Export complete (14.04s). Visualize with https://github.com/lutzroeder/netron.




# try to fix onnxsim

Simplifier failure: No module named 'onnxsim'

# CoreML error is OK (no observed impact of ignoring this)

CoreML export failure: No module named 'coremltools'


# from ???
!python yolov7/seg/export.py --data /path/to/dataset.yaml --weights /path/to/best.pt --img 512 512 --device 0 --simplify --opset 12 --include onnx
   
# does not work
python export.py --weights runs/train/poland1b_det2/weights/best.pt --grid --end2end --simplify --topk-all 100 --iou-thres 0.65 --conf-thres 0.35 --img-size 640 640 --max-wh 640

# from deepness notebook
!python export.py --weights runs/train/yolov7-car-detector/weights/best.pt --grid --simplify --img-size 640 640
	

# new
python export.py --weights runs/train/poland1b_det2/weights/best.pt --grid --simplify --img-size 1216 1216
python export.py --weights runs/train/poland1-100_det/weights/best.pt --grid --simplify --img-size 1216 1216


